üéØ –û–ë–© –ü–†–ï–ì–õ–ï–î –ù–ê FAIL2BAN
–ö–∞–∫–≤–æ –µ Fail2ban?

Fail2ban –µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∑–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –±—Ä—É—Ç-—Ñ–æ—Ä—Å –∞—Ç–∞–∫–∏, –∫–æ–π—Ç–æ –º–æ–Ω–∏—Ç–æ—Ä–∏—Ä–∞ –ª–æ–≥–æ–≤–µ—Ç–µ –Ω–∞ —Å–∏—Å—Ç–µ–º–∏—Ç–µ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –±–ª–æ–∫–∏—Ä–∞ IP –∞–¥—Ä–µ—Å–∏, –∫–æ–∏—Ç–æ –ø–æ–∫–∞–∑–≤–∞—Ç –∑–ª–æ–Ω–∞–º–µ—Ä–µ–Ω–æ –ø–æ–≤–µ–¥–µ–Ω–∏–µ.
–û—Å–Ω–æ–≤–Ω–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏:

    Jails (–ó–∞—Ç–≤–æ—Ä–∏) - –ø—Ä–∞–≤–∏–ª–∞ –∑–∞ —Ä–∞–∑–ª–∏—á–Ω–∏ —Ç–∏–ø–æ–≤–µ –∞—Ç–∞–∫–∏

    Filters (–§–∏–ª—Ç—Ä–∏) - —Ä–µ–≥—É–ª—è—Ä–Ω–∏ –∏–∑—Ä–∞–∑–∏ –∑–∞ –æ—Ç–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ –∞—Ç–∞–∫–∏

    Actions (–î–µ–π—Å—Ç–≤–∏—è) - –∫–∞–∫–≤–æ –¥–∞ —Å–µ –Ω–∞–ø—Ä–∞–≤–∏ –ø—Ä–∏ –æ—Ç–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ –∞—Ç–∞–∫–∞

    Log files (–õ–æ–≥–æ–≤–µ) - –∏–∑—Ç–æ—á–Ω–∏—Ü–∏ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –∞—Ç–∞–∫–∏

üìÅ –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ò –§–ê–ô–õ–û–í–ê –°–¢–†–£–ö–¢–£–†–ê
–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:
text

/etc/fail2ban/
‚îú‚îÄ‚îÄ jail.conf              # –û—Å–Ω–æ–≤–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–ù–ï –†–ï–î–ê–ö–¢–ò–†–ê–ô–¢–ï!)
‚îú‚îÄ‚îÄ jail.local             # –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–†–ï–î–ê–ö–¢–ò–†–ê–ô–¢–ï –¢–û–í–ê!)
‚îú‚îÄ‚îÄ filter.d/              # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∑–∞ —Ñ–∏–ª—Ç—Ä–∏
‚îÇ   ‚îú‚îÄ‚îÄ nginx-http-auth.conf
‚îÇ   ‚îú‚îÄ‚îÄ nginx-bad-request.conf
‚îÇ   ‚îú‚îÄ‚îÄ sshd.conf
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ action.d/              # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∑–∞ –¥–µ–π—Å—Ç–≤–∏—è
‚îî‚îÄ‚îÄ jail.d/                # –î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∏ jail –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–î–∞–Ω–Ω–µ–Ω–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:
text

/var/lib/fail2ban/         # –ë–∞–∑–∞ –¥–∞–Ω–Ω–∏ –∏ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ —Å—ä—Å—Ç–æ—è–Ω–∏–µ
/var/log/fail2ban.log      # –û—Å–Ω–æ–≤–µ–Ω –ª–æ–≥ —Ñ–∞–π–ª
/var/run/fail2ban/         # PID —Ñ–∞–π–ª–æ–≤–µ –∏ —Å–æ–∫–µ—Ç–∏

üîß –ö–û–†–ï–ù–ù–ò –ö–û–ù–¶–ï–ü–¶–ò–ò
1. Jail (–ó–∞—Ç–≤–æ—Ä)

–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: –ì—Ä—É–ø–∞ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, –∫–æ–∏—Ç–æ –¥–µ—Ñ–∏–Ω–∏—Ä–∞—Ç –∫–∞–∫ –¥–∞ —Å–µ –æ–±—Ä–∞–±–æ—Ç–≤–∞ –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω —Ç–∏–ø –∞—Ç–∞–∫–∞.

–ü—Ä–∏–º–µ—Ä–µ–Ω jail:
ini

[nginx-hidden-files]
enabled   = true
port      = http,https
filter    = nginx-hidden-files
logpath   = /var/log/nginx/access.log
maxretry  = 1
findtime  = 3600
bantime   = 259200
action    = iptables-multiport

–ü–∞—Ä–∞–º–µ—Ç—Ä–∏:

    enabled - –¥–∞–ª–∏ jail-–∞ –µ –∞–∫—Ç–∏–≤–µ–Ω (true/false)

    port - –ø–æ—Ä—Ç–æ–≤–µ –∑–∞ –±–ª–æ–∫–∏—Ä–∞–Ω–µ

    filter - –∏–º–µ –Ω–∞ —Ñ–∏–ª—Ç—ä—Ä —Ñ–∞–π–ª

    logpath - –ø—ä—Ç –¥–æ –ª–æ–≥ —Ñ–∞–π–ª –∑–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

    maxretry - –º–∞–∫—Å–∏–º–∞–ª–Ω–∏ –æ–ø—Ä–µ–¥–∏ –ø—Ä–µ–¥–∏ –±–ª–æ–∫–∏—Ä–∞–Ω–µ

    findtime - –≤—Ä–µ–º–µ–≤–∏ –ø—Ä–æ–∑–æ—Ä–µ—Ü –∑–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ (–≤ —Å–µ–∫—É–Ω–¥–∏)

    bantime - –≤—Ä–µ–º–µ –∑–∞ –±–ª–æ–∫–∏—Ä–∞–Ω–µ (–≤ —Å–µ–∫—É–Ω–¥–∏)

    action - –¥–µ–π—Å—Ç–≤–∏–µ –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–∞–Ω–µ

2. Filter (–§–∏–ª—Ç—ä—Ä)

–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: –†–µ–≥—É–ª—è—Ä–Ω–∏ –∏–∑—Ä–∞–∑–∏ –∑–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–∞–Ω–µ –Ω–∞ –∑–ª–æ–Ω–∞–º–µ—Ä–µ–Ω–∏ –∑–∞—è–≤–∫–∏.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞ —Ñ–∏–ª—Ç—ä—Ä —Ñ–∞–π–ª:
ini

[Definition]
failregex = ^<HOST> -.*"(GET|POST).*\/\.env.*HTTP.*
ignoreregex = ^<HOST> -.*"GET.*\/robots\.txt.*HTTP.*

–°–ø–µ—Ü–∏–∞–ª–Ω–∏ –º–∞—Ä–∫–µ—Ä–∏:

    <HOST> - IP –∞–¥—Ä–µ—Å –Ω–∞ –∞—Ç–∞–∫—É–≤–∞—â–∏—è

    –ú–æ–∂–µ –¥–∞ —Å–µ –∏–∑–ø–æ–ª–∑–≤–∞—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏ —Ä–µ–≥—É–ª—è—Ä–Ω–∏ –∏–∑—Ä–∞–∑–∏

3. Action (–î–µ–π—Å—Ç–≤–∏–µ)

–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: –ö–∞–∫–≤–æ –¥–∞ —Å–µ –Ω–∞–ø—Ä–∞–≤–∏ –ø—Ä–∏ –æ—Ç–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ –∞—Ç–∞–∫–∞.

–ß–µ—Å—Ç–æ –∏–∑–ø–æ–ª–∑–≤–∞–Ω–∏ –¥–µ–π—Å—Ç–≤–∏—è:

    iptables-multiport - –±–ª–æ–∫–∏—Ä–∞–Ω–µ —Å iptables

    shorewall - –±–ª–æ–∫–∏—Ä–∞–Ω–µ —Å Shorewall

    sendmail - –∏–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ email

    %(action_mwl)s - –º–Ω–æ–∂–µ—Å—Ç–≤–æ –¥–µ–π—Å—Ç–≤–∏—è (mail, whois, –ª–æ–≥)

üîÑ –†–ê–ë–û–¢–ï–ù –ü–†–û–¶–ï–° (FLOW)
–ñ–∏–∑–Ω–µ–Ω —Ü–∏–∫—ä–ª –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞:
text

1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –Ω–∞ –ª–æ–≥–æ–≤–µ—Ç–µ
   ‚Üì
2. –ü—Ä–∏–ª–∞–≥–∞–Ω–µ –Ω–∞ —Ñ–∏–ª—Ç—Ä–∏
   ‚Üì
3. –ë—Ä–æ–µ–Ω–µ –Ω–∞ —Å—ä–≤–ø–∞–¥–µ–Ω–∏—è
   ‚Üì
4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–ª–∏ maxretry –µ –¥–æ—Å—Ç–∏–≥–Ω–∞—Ç
   ‚Üì
5. –ò–∑–ø—ä–ª–Ω–µ–Ω–∏–µ –Ω–∞ –¥–µ–π—Å—Ç–≤–∏–µ (–±–ª–æ–∫–∏—Ä–∞–Ω–µ)
   ‚Üì
6. –ó–∞–ø–∏—Å –≤ –±–∞–∑–∞—Ç–∞ –¥–∞–Ω–Ω–∏
   ‚Üì
7. –õ–æ–≥–≤–∞–Ω–µ –Ω–∞ —Å—ä–±–∏—Ç–∏–µ—Ç–æ

–ü—Ä–∏–º–µ—Ä–µ–Ω –ø–æ—Ç–æ–∫ –∑–∞ nginx –∞—Ç–∞–∫–∞:
text

Nginx –ª–æ–≥: 194.180.49.167 - GET /.env HTTP/1.1 404
   ‚Üì
–§–∏–ª—Ç—ä—Ä nginx-hidden-files: –°–™–í–ü–ê–î–ï–ù–ò–ï
   ‚Üì
–£–≤–µ–ª–∏—á–∞–≤–∞–Ω–µ –Ω–∞ –±—Ä–æ—è—á–∞ –∑–∞ IP: 194.180.49.167
   ‚Üì
–ü—Ä–æ–≤–µ—Ä–∫–∞: maxretry=1 ‚Üí –ë–õ–û–ö–ò–†–ê–ù–ï
   ‚Üì
–î–µ–π—Å—Ç–≤–∏–µ: iptables -A INPUT -s 194.180.49.167 -j DROP
   ‚Üì
–õ–æ–≥: [nginx-hidden-files] Ban 194.180.49.167

üìä –î–ê–ù–ù–ï–ù–ò –ò –°–™–°–¢–û–Ø–ù–ò–Ø
–ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ —Å—ä—Å—Ç–æ—è–Ω–∏–µ:

Fail2ban –ø–∞–∑–∏ —Å—ä—Å—Ç–æ—è–Ω–∏–µ—Ç–æ –≤ SQLite –±–∞–∑–∞ –¥–∞–Ω–Ω–∏:
sql

-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞ –±–∞–Ω–Ω–∞—Ç–∏ IP –∞–¥—Ä–µ—Å–∏
CREATE TABLE bans (
    jail TEXT,
    ip TEXT,
    timeofban INTEGER,
    bantime INTEGER,
    PRIMARY KEY (jail, ip)
);

-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞ —Å—ä–±–∏—Ç–∏—è
CREATE TABLE logs (
    id INTEGER PRIMARY KEY,
    jail TEXT,
    ip TEXT,
    time INTEGER,
    action TEXT
);

–í—ä—Ç—Ä–µ—à–Ω–æ —Å—ä—Å—Ç–æ—è–Ω–∏–µ:
python

# –ü—Å–µ–≤–¥–æ-–∫–æ–¥ –∑–∞ –≤—ä—Ç—Ä–µ—à–Ω–æ —Å—ä—Å—Ç–æ—è–Ω–∏–µ
fail2ban_state = {
    "jails": {
        "nginx-hidden-files": {
            "enabled": True,
            "counters": {
                "194.180.49.167": {
                    "count": 1,
                    "first_seen": 1735142400,
                    "last_seen": 1735142400
                }
            },
            "banned_ips": ["194.180.49.167", "194.180.49.173"]
        }
    },
    "system": {
        "start_time": 1735142400,
        "total_bans": 25,
        "active_jails": 8
    }
}

üéõÔ∏è API –ò –ö–û–ú–ê–ù–î–ò
Fail2ban-client –∫–æ–º–∞–Ω–¥–∏:
bash

# –û—Å–Ω–æ–≤–Ω–∏ –∫–æ–º–∞–Ω–¥–∏
sudo fail2ban-client status                    # –û–±—â —Å—Ç–∞—Ç—É—Å
sudo fail2ban-client status <jail>            # –°—Ç–∞—Ç—É—Å –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–µ–Ω jail
sudo fail2ban-client start <jail>             # –°—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–µ –Ω–∞ jail
sudo fail2ban-client stop <jail>              # –°–ø–∏—Ä–∞–Ω–µ –Ω–∞ jail
sudo fail2ban-client reload                    # –ü—Ä–µ–∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
sudo fail2ban-client set <jail> banip <IP>    # –†—ä—á–Ω–æ –±–ª–æ–∫–∏—Ä–∞–Ω–µ
sudo fail2ban-client set <jail> unbanip <IP>  # –†—ä—á–Ω–æ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–∞–Ω–µ

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∏ –∫–æ–º–∞–Ω–¥–∏
sudo fail2ban-client get <jail> logpath       # –í–∑–µ–º–∏ logpath –∑–∞ jail
sudo fail2ban-client get <jail> findtime      # –í–∑–µ–º–∏ findtime –∑–∞ jail
sudo fail2ban-client get <jail> maxretry      # –í–∑–µ–º–∏ maxretry –∑–∞ jail

# –¢–µ—Å—Ç–æ–≤–∏ –∫–æ–º–∞–Ω–¥–∏
sudo fail2ban-regex <–ª–æ–≥ —Ñ–∞–π–ª> <—Ñ–∏–ª—Ç—ä—Ä>       # –¢–µ—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Ñ–∏–ª—Ç—ä—Ä

–°–∏—Å—Ç–µ–º–Ω–∏ –∫–æ–º–∞–Ω–¥–∏:
bash

# Systemd —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
sudo systemctl start fail2ban
sudo systemctl stop fail2ban
sudo systemctl restart fail2ban
sudo systemctl status fail2ban
sudo systemctl enable fail2ban
sudo systemctl disable fail2ban

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ iptables
sudo iptables -L -n -v | grep fail2ban

üìà –°–¢–ê–¢–ò–°–¢–ò–ö–ò –ò –ú–ï–¢–†–ò–ö–ò
–ú–µ—Ç—Ä–∏–∫–∏ –∑–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:
json

{
  "global_metrics": {
    "total_jails": 8,
    "active_jails": 8,
    "total_bans": 25,
    "active_bans": 18,
    "uptime_seconds": 86400,
    "last_ban_time": "2025-12-25T16:23:51",
    "ban_rate_per_hour": 2.5
  },
  "per_jail_metrics": {
    "nginx-hidden-files": {
      "bans_total": 15,
      "bans_active": 12,
      "failures_current": 3,
      "failures_total": 45,
      "last_activity": "2025-12-25T16:19:38"
    },
    "nginx-admin-scanners": {
      "bans_total": 10,
      "bans_active": 6,
      "failures_current": 1,
      "failures_total": 32,
      "last_activity": "2025-12-25T16:17:44"
    }
  },
  "top_offenders": [
    {"ip": "194.180.49.167", "bans": 3, "last_seen": "2025-12-25T16:19:38"},
    {"ip": "194.180.49.173", "bans": 3, "last_seen": "2025-12-25T16:19:38"},
    {"ip": "66.249.79.1", "bans": 2, "last_seen": "2025-12-25T16:23:51"}
  ]
}

üõ°Ô∏è –ó–ê–©–ò–¢–ù–ò –ú–ï–•–ê–ù–ò–ó–ú–ò
1. Rate Limiting:
ini

# –í jail –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞
maxretry = 3      # –ú–∞–∫—Å–∏–º–∞–ª–Ω–∏ –æ–ø—Ä–µ–¥–∏
findtime = 600    # –í 10-–º–∏–Ω—É—Ç–µ–Ω –ø—Ä–æ–∑–æ—Ä–µ—Ü
bantime = 3600    # –ë–ª–æ–∫–∏—Ä–∞–Ω–µ –∑–∞ 1 —á–∞—Å

2. Ignore IP:
ini

# –í DEFAULT —Å–µ–∫—Ü–∏—è—Ç–∞
ignoreip = 127.0.0.1/8 192.168.0.0/16 ::1

3. Whitelisting –≤ —Ñ–∏–ª—Ç—Ä–∏:
ini

# –í ignoreregex —Å–µ–∫—Ü–∏—è—Ç–∞
ignoreregex = ^<HOST> -.*"GET.*\/robots\.txt.*HTTP.*
              ^<HOST> -.*"Googlebot.*HTTP.*

üîç –ê–ù–ê–õ–ò–ó –ù–ê –õ–û–ì–û–í–ï–¢–ï
–§–æ—Ä–º–∞—Ç –Ω–∞ fail2ban.log:
text

TIMESTAMP COMPONENT        [PID]: LEVEL   [JAIL] MESSAGE
2025-12-25 16:23:51,940 fail2ban.actions [290181]: NOTICE  [nginx-hidden-files] Unban 91.232.238.112

–ö–ª—é—á–æ–≤–∏ —Å—ä–±–∏—Ç–∏—è:

    NOTICE [jail] Ban IP - –±–ª–æ–∫–∏—Ä–∞–Ω–µ –Ω–∞ IP

    NOTICE [jail] Unban IP - —Ä–∞–∑–±–ª–æ–∫–∏—Ä–∞–Ω–µ –Ω–∞ IP

    INFO [jail] Found IP - –æ—Ç–∫—Ä–∏–≤–∞–Ω–µ –Ω–∞ –∞—Ç–∞–∫–∞

    WARNING - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

    ERROR - –≥—Ä–µ—à–∫–∏ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞

–ü–∞—Ä—Å–≤–∞–Ω–µ –Ω–∞ –ª–æ–≥–æ–≤–µ:
python

# –ü—Å–µ–≤–¥–æ-–∫–æ–¥ –∑–∞ –ø–∞—Ä—Å–≤–∞–Ω–µ
log_pattern = r'(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}),\d+ (\w+)\s+\[\d+\]: (\w+)\s+\[([^\]]+)\] (.+)'

# –ò–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
match = re.match(log_pattern, log_line)
if match:
    timestamp, component, level, jail, message = match.groups()

‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò –ó–ê –ü–†–û–ò–ó–í–û–î–°–¢–í–û
–û–ø—Ç–∏–º–∞–ª–Ω–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
ini

[DEFAULT]
# –ó–∞—â–∏—Ç–∞ —Å—Ä–µ—â—É –±—Ä—É—Ç-—Ñ–æ—Ä—Å
bantime  = 86400            # 24 —á–∞—Å–∞
findtime = 600              # 10 –º–∏–Ω—É—Ç–∏
maxretry = 5                # 5 –æ–ø–∏—Ç–∞

# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ —Ä–µ—Å—É—Ä—Å–∏—Ç–µ
backend = auto              # –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ—Ç–∫—Ä–∏–≤–∞–Ω–µ
usedns = warn               # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∑–∞ DNS –∑–∞—è–≤–∫–∏

# –õ–æ–≥–≤–∞–Ω–µ
loglevel = INFO
logtarget = /var/log/fail2ban.log
socket = /var/run/fail2ban/fail2ban.sock
pidfile = /var/run/fail2ban/fail2ban.pid

NGINX —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:
ini

[nginx-hidden-files]
# –ê–≥—Ä–µ—Å–∏–≤–Ω–∞ –∑–∞—â–∏—Ç–∞ –∑–∞ .env/.git —Ñ–∞–π–ª–æ–≤–µ
maxretry = 1
findtime = 3600
bantime = 259200  # 3 –¥–Ω–∏

[nginx-404]
# –ü–æ-–ª–µ–∫–æ –∑–∞ 404 –≥—Ä–µ—à–∫–∏
maxretry = 5
findtime = 300
bantime = 3600    # 1 —á–∞—Å

üö® –ß–ï–°–¢–ò –ì–†–ï–®–ö–ò –ò –†–ï–®–ï–ù–ò–Ø
1. Jail –Ω–µ —Å–µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞:
bash

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è—Ç–∞
sudo fail2ban-client -d
sudo tail -50 /var/log/fail2ban.log

# –†–µ—à–µ–Ω–∏–µ: –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –¥–∞–ª–∏ —Ñ–∏–ª—Ç—ä—Ä —Ñ–∞–π–ª–∞ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞
ls /etc/fail2ban/filter.d/nginx-hidden-files.conf

2. –ù–µ –±–ª–æ–∫–∏—Ä–∞ IP –∞–¥—Ä–µ—Å–∏:
bash

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ñ–∏–ª—Ç—Ä–∏—Ç–µ
sudo fail2ban-regex /var/log/nginx/access.log /etc/fail2ban/filter.d/nginx-hidden-files.conf

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ iptables
sudo iptables -L -n -v

3. –ì—Ä–µ—à–∫–∏ –ø—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç:
bash

# –ò–∑—á–∏—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Å—Ç–∞—Ä–æ —Å—ä—Å—Ç–æ—è–Ω–∏–µ
sudo systemctl stop fail2ban
sudo rm -f /var/run/fail2ban/fail2ban.sock
sudo rm -f /var/lib/fail2ban/fail2ban.sqlite3-journal
sudo systemctl start fail2ban

üîó –ò–ù–¢–ï–ì–†–ê–¶–ò–ò
1. REST API (—á—Ä–µ–∑ fail2ban-client):
python

import subprocess
import json

class Fail2BanAPI:
    def get_status(self):
        result = subprocess.run(
            ['sudo', 'fail2ban-client', 'status'],
            capture_output=True, text=True
        )
        return self._parse_status(result.stdout)
    
    def ban_ip(self, jail, ip):
        subprocess.run(['sudo', 'fail2ban-client', 'set', jail, 'banip', ip])
    
    def get_jail_stats(self, jail):
        result = subprocess.run(
            ['sudo', 'fail2ban-client', 'status', jail],
            capture_output=True, text=True
        )
        return self._parse_jail_status(result.stdout)

2. –ë–∞–∑–∞ –¥–∞–Ω–Ω–∏ (SQLite):
python

import sqlite3

def get_active_bans():
    conn = sqlite3.connect('/var/lib/fail2ban/fail2ban.sqlite3')
    cursor = conn.cursor()
    
    cursor.execute("""
        SELECT jail, ip, timeofban, bantime 
        FROM bans 
        WHERE (timeofban + bantime) > ?
    """, (int(time.time()),))
    
    return cursor.fetchall()

3. Webhook –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏:
ini

# –í jail.local
action = %(action_)s
         %(action_mwl)s
         %(action_webhook)s[http://api.hashmatrix.de/webhook/fail2ban]

üìä UI/UX –ò–ù–¢–ï–†–§–ï–ô–°–ù–ò –ï–õ–ï–ú–ï–ù–¢–ò
–î–∞–Ω–Ω–∏ –Ω—É–∂–Ω–∏ –∑–∞ UI:
json

{
  "dashboard": {
    "total_bans": 25,
    "active_bans": 18,
    "total_jails": 8,
    "active_jails": 8,
    "last_24h_bans": 12,
    "top_attack_types": ["hidden-files", "admin-scanners", "404"],
    "top_offenders": ["194.180.49.167", "194.180.49.173", "66.249.79.1"]
  },
  "jails": [
    {
      "name": "nginx-hidden-files",
      "enabled": true,
      "stats": {
        "bans_total": 15,
        "bans_active": 12,
        "failures_today": 8,
        "last_ban": "2025-12-25T16:19:38"
      },
      "config": {
        "maxretry": 1,
        "findtime": 3600,
        "bantime": 259200,
        "logpath": "/var/log/nginx/access.log"
      }
    }
  ],
  "recent_activity": [
    {
      "timestamp": "2025-12-25T16:23:51",
      "jail": "nginx-hidden-files",
      "ip": "91.232.238.112",
      "action": "unban",
      "reason": "ban expired"
    }
  ]
}

UI –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏:

    Dashboard - –æ–±—â –ø—Ä–µ–≥–ª–µ–¥

    Jails Manager - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ jails

    Bans List - —Å–ø–∏—Å—ä–∫ —Å –±–ª–æ–∫–∏—Ä–∞–Ω–∏ IP

    Live Logs - —Ä–µ–∞–ª–Ω–æ –≤—Ä–µ–º–µ –ª–æ–≥–æ–≤–µ

    Statistics - –≥—Ä–∞—Ñ–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏–∑–∏

    Configuration - —Ä–µ–¥–∞–∫—Ç–æ—Ä –Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

üéÆ –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–ò –ö–û–ú–ê–ù–î–ò –ó–ê CURSOR
–ö–æ–º–∞–Ω–¥–∏ –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:
bash

# 1. –í–∑–µ–º–∏ —Ç–µ–∫—É—â —Å—Ç–∞—Ç—É—Å
curl -X GET https://api.hashmatrix.de/fail2ban/status

# 2. –ë–ª–æ–∫–∏—Ä–∞–π IP
curl -X POST https://api.hashmatrix.de/fail2ban/ban \
  -H "Content-Type: application/json" \
  -d '{"jail": "nginx-hidden-files", "ip": "1.2.3.4"}'

# 3. –†–∞–∑–±–ª–æ–∫–∏—Ä–∞–π IP
curl -X POST https://api.hashmatrix.de/fail2ban/unban \
  -H "Content-Type: application/json" \
  -d '{"jail": "nginx-hidden-files", "ip": "1.2.3.4"}'

# 4. –í–∑–µ–º–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
curl -X GET https://api.hashmatrix.de/fail2ban/stats

# 5. –ü—Ä–æ–º–µ–Ω–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ jail
curl -X PUT https://api.hashmatrix.de/fail2ban/jail/nginx-hidden-files \
  -H "Content-Type: application/json" \
  -d '{"maxretry": 2, "bantime": 172800}'

WebSocket –∑–∞ —Ä–µ–∞–ª–Ω–æ –≤—Ä–µ–º–µ:
javascript

// –†–µ—Ñ–µ—Ä–µ–Ω—Ü–∏—è –∑–∞ WebSocket –≤—Ä—ä–∑–∫–∞
const ws = new WebSocket('wss://api.hashmatrix.de/fail2ban/ws');

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  if (data.type === 'BAN') {
    console.log(`New ban: ${data.ip} in ${data.jail}`);
  } else if (data.type === 'UNBAN') {
    console.log(`IP unbanned: ${data.ip} from ${data.jail}`);
  }
};

üß™ –¢–ï–°–¢–û–í–ò –°–¶–ï–ù–ê–†–ò–ò
–¢–µ—Å—Ç–æ–≤–∏ –∞—Ç–∞–∫–∏ –∑–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è:
bash

# –¢–µ—Å—Ç –∑–∞ .env –∞—Ç–∞–∫–∏
curl -X GET http://hashmatrix.de/.env

# –¢–µ—Å—Ç –∑–∞ admin —Å–∫–µ–Ω–µ—Ä–∏
curl -X GET http://hashmatrix.de/wp-admin

# –¢–µ—Å—Ç –∑–∞ WebDAV –∞—Ç–∞–∫–∏
curl -X PROPFIND http://hashmatrix.de/

# –¢–µ—Å—Ç –∑–∞ robots.txt (–Ω–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –±–ª–æ–∫–∏—Ä–∞)
curl -X GET http://hashmatrix.de/robots.txt

–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏ —Ç–µ—Å—Ç–æ–≤–µ:
python

def test_fail2ban_integration():
    # 1. –ò–∑–ø—Ä–∞—Ç–∏ —Ç–µ—Å—Ç–æ–≤–∞ –∞—Ç–∞–∫–∞
    send_test_attack("194.180.49.167", "/.env")
    
    # 2. –ü—Ä–æ–≤–µ—Ä–∏ –¥–∞–ª–∏ –µ –±–ª–æ–∫–∏—Ä–∞–Ω
    time.sleep(60)
    bans = get_active_bans()
    
    # 3. –í–∞–ª–∏–¥–∏—Ä–∞–π
    assert "194.180.49.167" in bans
    assert bans["194.180.49.167"]["jail"] == "nginx-hidden-files"

üìö –†–ï–°–£–†–°–ò –ò –†–ï–§–ï–†–ï–ù–¶–ò–ò
–ü–æ–ª–µ–∑–Ω–∏ —Ñ–∞–π–ª–æ–≤–µ –∑–∞ Cursor:

    /etc/fail2ban/jail.local - –æ—Å–Ω–æ–≤–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

    /etc/fail2ban/filter.d/ - —Ñ–∏–ª—Ç—Ä–∏ –∑–∞ —Ä–∞–∑–ª–∏—á–Ω–∏ –∞—Ç–∞–∫–∏

    /var/log/fail2ban.log - –ª–æ–≥–æ–≤–µ –Ω–∞ –¥–µ–π–Ω–æ—Å—Ç–∏—Ç–µ

    /var/lib/fail2ban/fail2ban.sqlite3 - –±–∞–∑–∞ –¥–∞–Ω–Ω–∏

–ö–ª—é—á–æ–≤–∏ –∫–æ–º–∞–Ω–¥–∏ –∑–∞ –¥–µ–±—ä–≥:
bash

# –î–µ–±—ä–≥ –Ω–∞ —Ñ–∏–ª—Ç—Ä–∏
sudo fail2ban-regex /var/log/nginx/access.log /etc/fail2ban/filter.d/nginx-hidden-files.conf --print-all-matched

# –î–µ—Ç–∞–π–ª–µ–Ω –¥–µ–±—ä–≥
sudo fail2ban-client -d

# –¢–µ—Å—Ç –Ω–∞ jail
sudo fail2ban-client status nginx-hidden-files

üèÅ –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

Fail2ban –µ –º–æ—â–µ–Ω –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∑–∞ —Å–∏–≥—É—Ä–Ω–æ—Å—Ç, –∫–æ–π—Ç–æ:

    –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ä–∞ –ª–æ–≥–æ–≤–µ –≤ —Ä–µ–∞–ª–Ω–æ –≤—Ä–µ–º–µ

    –û—Ç–∫—Ä–∏–≤–∞ —à–∞–±–ª–æ–Ω–∏ –Ω–∞ –∞—Ç–∞–∫–∏ —á—Ä–µ–∑ —Ä–µ–≥—É–ª—è—Ä–Ω–∏ –∏–∑—Ä–∞–∑–∏

    –ë–ª–æ–∫–∏—Ä–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–ª–æ–Ω–∞–º–µ—Ä–µ–Ω–∏ IP –∞–¥—Ä–µ—Å–∏

    –ó–∞–ø–∞–∑–≤–∞ —Å—ä—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–∏—è

    –ü—Ä–µ–¥–æ—Å—Ç–∞–≤—è API –∑–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ

–ó–∞ Cursor AI: –¢–æ–∑–∏ –¥–æ–∫—É–º–µ–Ω—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—è –ø—ä–ª–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞ —Ä–∞–±–æ—Ç–∞—Ç–∞ –Ω–∞ Fail2ban, –Ω–µ–≥–æ–≤–∞—Ç–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –¥–∞–Ω–Ω–µ–Ω–∏ –º–æ–¥–µ–ª–∏ –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∏, –Ω–µ–æ–±—Ö–æ–¥–∏–º–∏ –∑–∞ —Å—ä–∑–¥–∞–≤–∞–Ω–µ—Ç–æ –Ω–∞ UI –∏ API, –∫–æ–∏—Ç–æ –¥–∞ —É–ø—Ä–∞–≤–ª—è–≤–∞—Ç —Å–∏—Å—Ç–µ–º–∞—Ç–∞ –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ.

–ö–ª—é—á–æ–≤–∏ —Ç–æ—á–∫–∏ –∑–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:

    –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ fail2ban-client –∑–∞ CLI –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ

    –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ä–∞–π—Ç–µ /var/log/fail2ban.log –∑–∞ —Å—ä–±–∏—Ç–∏—è

    –ò–∑–ø–æ–ª–∑–≤–∞–π—Ç–µ SQLite –±–∞–∑–∞—Ç–∞ –∑–∞ –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–∏ –¥–∞–Ω–Ω–∏

    –ò–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä–∞–π—Ç–µ WebSocket –∑–∞ —Ä–µ–∞–ª–Ω–æ –≤—Ä–µ–º–µ –Ω–æ—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

    –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–µ—Ç–µ REST API –∑–∞ –≤—ä–Ω—à–µ–Ω –∫–æ–Ω—Ç—Ä–æ–ª
